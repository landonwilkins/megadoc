#!/usr/bin/env bash

# Set up the core and all dependent packages; their NPM dependencies and HTML
# assets.

set -e

[ -f "./package.json" ] && grep '"name": "megadoc"' ./package.json &> /dev/null || {
  echo "$0: Must be run from megadoc root.";
  exit 1
}

#export NODE_PATH="./packages:${NODE_PATH}"

npm install --ignore-scripts
npm run build # build failures should count!

if [ "${PRELINK}" == "1" ]; then
  npm link --ignore-scripts
fi

for pkg in $(find packages -maxdepth 1 -type d -name 'megadoc-*' | sort | sed 's/packages\///')
do
  if [ $pkg == "megadoc-plugin-skeleton" ]; then
    continue
  fi

  # prepublish a single package but skip its tests/lints since we already do
  # them implicitly in `npm run publish`...
  ./bin/prepublish $pkg -S lint -S test
done